<template>
  <Head>
    <Title>{{ fields.title }}</Title>
    <Meta name="og:title" hid="og:title" :content="fields.title" />
    <Meta name="twitter:title" :content="fields.title" />
    <Meta name="description" hid="description" :content="fields.description" />
    <Meta name="og:description" hid="og:description" :content="fields.description" />
    <Meta name="twitter:description" :content="fields.description" />
  </Head>
  <div>
    <breadcrumb :breadcrumb="breadcrumb" :title="title" />
    <page-hero class="py-24">
      <h1>{{ title }}</h1>
      <p>
        {{ description }}
      </p>
    </page-hero>
    <portal-features :features="appEntries" :title="appsSectionTitle" :icon-is-top-element="false" :max-per-row="3" />
    <div class="container" :style="'text-align: center; margin-top: 1rem; margin-bottom: 2rem;'" v-html="parseMarkdown(footer)" />
  </div>
</template>

<script>
import PortalFeatures from '@/components/PortalFeatures/PortalFeatures.vue'
import MarkedMixin from '@/mixins/marked'
import { pathOr, propOr } from 'ramda'

const constructPortalFeatureEntries = (apps) => {
  if (apps == undefined) {
    return []
  }
  let entries = []
  apps.forEach(app => {
    const buttonLink = app.fields.requiresDetailsPage ? `/resources/${app.sys.id}` : pathOr('', ['fields', 'url'], app)
    const appEntry = {
      fields: {
        buttonLink: buttonLink,
        buttonText: pathOr('', ['fields', 'buttonText'], app),
        description: pathOr('', ['fields', 'description'], app),
        title: pathOr('', ['fields', 'name'], app),
        icon: {
          fields: {
            file: {
              url: pathOr('', ['fields', 'logo', 'fields', 'file', 'url'], app),
            },
          },
        },
      }
    }
    entries.push(
      appEntry
    )
  })
  return entries
}

export default {
  name: 'AppsPage',
  components: {
    PortalFeatures
  },
  mixins: [MarkedMixin],
  async setup() {
    const config = useRuntimeConfig()
    const { $contentfulClient } = useNuxtApp()
    try {
      const appPage = await $contentfulClient.getEntry(config.public.ctf_apps_page_id)
      const appEntries = constructPortalFeatureEntries(appPage.fields?.apps)
      return {
        appEntries,
        fields: appPage.fields,
      }
    } catch (e) {
      console.error(e)
    }
  },

  data() {
    return {
      breadcrumb: [
        {
          to: {
            name: 'index'
          },
          label: 'Home'
        }
      ]
    }
  },

  computed: {
    title: function () {
      return this.fields.title
    },
    description: function () {
      return this.fields.description
    },
    appsSectionTitle: function () {
      return propOr('', 'appsSectionTitle', this.fields)
    },
    footer: function () {
      return propOr('', 'footerText', this.fields)
    }
  }
}
</script>

<style lang="scss" scoped>
@import 'sparc-design-system-components-2/src/assets/_variables.scss';

</style>
